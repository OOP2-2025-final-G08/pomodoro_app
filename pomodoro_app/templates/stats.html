{% extends "base.html" %}

{% block title %}実績グラフ{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm p-4" style="border-radius: 12px; background: white;">
        <h2 class="text-center mb-4" style="color: #444; font-weight: bold;">
            {{ year }}年{{ month }}月の実績グラフ
        </h2>
        
        <div style="position: relative; height: 60vh; width: 100%;">
            <canvas id="statsChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('statsChart');
    
    if (ctx) {
        fetch('/api/stats/chart-data')
            .then(res => {
                if (!res.ok) throw new Error('API Error');
                return res.json();
            })
            .then(data => {
                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: '完了数',
                                data: data.completed,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                                order: 2
                            },
                            {
                                label: '目標数',
                                data: data.targets,
                                type: 'line',
                                borderColor: '#facc15',
                                backgroundColor: '#facc15',
                                borderWidth: 3,
                                pointBackgroundColor: '#facc15',
                                pointRadius: 5,
                                fill: false,
                                tension: 0,
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                suggestedMax: 5, /* ★ここ重要：データが0でも目盛りを5まで表示 */
                                ticks: { stepSize: 1 }
                            },
                            x: {
                                grid: { display: true, color: '#f3f4f6' }
                            }
                        }
                    }
                });
            })
            .catch(err => {
                console.error(err);
                // グラフが出ない場合、エラーメッセージを表示
                ctx.parentNode.innerHTML = '<p style="text-align:center; color:red;">データの読み込みに失敗しました。<br>データベースファイルを作り直してみてください。</p>';
            });
    }
});
</script>
{% endblock %}