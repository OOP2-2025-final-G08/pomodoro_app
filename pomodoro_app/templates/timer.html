{% extends "base.html" %}

{% block title %}タイマー & ルーレット{% endblock %}

{% block content %}
<div class="timer-container">
    <div class="roulette-section" id="roulette-section">
        <h3>今日の目標を決めよう</h3>
        <div class="roulette-display" id="roulette-result">?</div>
        <button id="spin-btn" class="btn btn-accent">ルーレットを回す</button>
        <p id="goal-msg" style="margin-top: 1rem; display: none; font-weight: 600;"></p>
    </div>

    <div class="timer-section">
        <div class="timer-label" id="timer-label">作業中</div>
        <div class="timer-display" id="timer-display">00:10</div>
        <div class="controls">
            <button id="start-btn" class="btn btn-primary">開始</button>
            <button id="pause-btn" class="btn btn-secondary" disabled>一時停止</button>
            <button id="reset-btn" class="btn btn-accent">リセット</button>
        </div>
    </div>
</div>

<audio id="alarm-sound" src="{{ url_for('static', filename='sounds/alarm.mp3') }}"></audio>
{% endblock %}

{% block scripts %}
<script>
// --- 時間設定（テスト用） ---
const WORK_TIME = 5;    // 作業時間5秒　一旦短縮本来は25分 = 1500秒
const BREAK_TIME = 10;  // 休憩時間10秒　一旦短縮本来は5分 = 300秒

let timerInterval;
let timeLeft = WORK_TIME;
let isRunning = false;
let currentMode = 'work';
let startTime;

const display = document.getElementById('timer-display');
const label = document.getElementById('timer-label');
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const resetBtn = document.getElementById('reset-btn');
const alarmSound = document.getElementById('alarm-sound');

const spinBtn = document.getElementById('spin-btn');
const rouletteResult = document.getElementById('roulette-result');
const goalMsg = document.getElementById('goal-msg');

function updateDisplay() {
    const mins = Math.floor(timeLeft / 60);
    const secs = timeLeft % 60;
    display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// 「開始」ボタンが押された時の処理
function startTimer() {
    if (isRunning) return;

    // --- 追加: アラームを強制停止 ---
    alarmSound.pause();
    alarmSound.currentTime = 0; // 再生位置を最初に戻す

    isRunning = true;
    startTime = new Date().toISOString();
    startBtn.disabled = true;
    pauseBtn.disabled = false;

    timerInterval = setInterval(() => {
        timeLeft--;
        updateDisplay();
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            finishSession();
        }
    }, 1000);
}

function pauseTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
}

function resetTimer() {
    pauseTimer();
    // リセット時もアラームを止める
    alarmSound.pause();
    alarmSound.currentTime = 0;
    
    timeLeft = currentMode === 'work' ? WORK_TIME : BREAK_TIME;
    updateDisplay();
}

function finishSession() {
    isRunning = false;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    
    const msg = currentMode === 'work' ? "作業終了！休憩しましょう。" : "休憩終了！作業を始めましょう。";
    
    // 音声を再生
    alarmSound.play().catch(e => console.log("再生ブロック: ", e));

    // 画面上にメッセージを表示
    goalMsg.textContent = msg;
    goalMsg.style.display = 'block';
    goalMsg.style.color = currentMode === 'work' ? '#3498db' : '#e67e22';
    
    setTimeout(() => {
        goalMsg.style.display = 'none';
    }, 5000);

    // 記録保存
    const endTime = new Date().toISOString();
    fetch('/api/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            start_time: startTime,
            end_time: endTime,
            status: 'completed',
            category: currentMode
        })
    });

    // モード切替
    if (currentMode === 'work') {
        currentMode = 'break';
        timeLeft = BREAK_TIME;
        label.textContent = '休憩中';
        label.style.color = 'var(--secondary-color)';
    } else {
        currentMode = 'work';
        timeLeft = WORK_TIME;
        label.textContent = '作業中';
        label.style.color = 'var(--text-color)';
    }
    updateDisplay();
}

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);

// ルーレットロジック
spinBtn.addEventListener('click', () => {
    spinBtn.disabled = true;
    let count = 0;
    const interval = setInterval(() => {
        rouletteResult.textContent = Math.floor(Math.random() * 9) + 4;
        count++;
        if (count > 20) {
            clearInterval(interval);
            saveGoal();
        }
    }, 50);
});

function saveGoal() {
    fetch('/api/goal', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                rouletteResult.textContent = data.target;
                goalMsg.textContent = `今日の目標は ${data.target} ポモドーロに決定しました！`;
                goalMsg.style.display = 'block';
                goalMsg.style.color = 'var(--secondary-color)';
            } else {
                rouletteResult.textContent = data.target;
                goalMsg.textContent = data.message;
                goalMsg.style.display = 'block';
            }
        });
}

fetch('/api/goal/today')
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            rouletteResult.textContent = data.target;
            spinBtn.disabled = true;
            goalMsg.textContent = `今日の目標は設定済みです。`;
            goalMsg.style.display = 'block';
        }
    });

updateDisplay();
</script>
{% endblock %}