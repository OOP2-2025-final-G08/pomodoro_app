{% extends "base.html" %}

{% block title %}ã‚¿ã‚¤ãƒãƒ¼ & ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ{% endblock %}

{% block content %}
<style>
    /* çŠ¶æ…‹åˆ¥ã®è‰²è¨­å®š */
    .theme-work {
        --main-color: #3498db;
        --bg-hover: #3498db;
        --btn-text: #3498db;
    }
    .theme-break {
        --main-color: #e67e22;
        --bg-hover: #e67e22;
        --btn-text: #e67e22;
    }

    .timer-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-top: 50px;
        font-family: "Hiragino Maru Gothic ProN", "Rounded Mplus 1c", sans-serif;
    }

    .goal-section {
        text-align: center;
        margin-bottom: 30px;
    }
    .goal-label {
        font-size: 1.1rem;
        color: #888;
        margin-bottom: 5px;
    }
    #roulette-result {
        font-size: 2.2rem;
        font-weight: bold;
        color: #444;
    }

    /* é”æˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    #achievement-msg {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 15px 30px;
        border-radius: 50px;
        margin-bottom: 20px;
        border: 2px solid #c3e6cb;
        font-weight: bold;
        animation: bounceIn 0.8s;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    @keyframes bounceIn {
        from { opacity: 0; transform: scale(0.5); }
        to { opacity: 1; transform: scale(1); }
    }

    .timer-circle-wrapper {
        position: relative;
        width: 320px;
        height: 320px;
        margin-bottom: 60px;
    }

    .timer-background {
        fill: none;
        stroke: #f0f0f0;
        stroke-width: 12;
    }

    .timer-progress {
        fill: none;
        stroke: var(--main-color);
        stroke-width: 12;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 1s linear, stroke 0.6s ease;
    }

    .no-transition {
        transition: none !important;
    }

    .timer-content {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    #timer-display {
        font-size: 5.5rem;
        font-weight: bold;
        color: #333;
        letter-spacing: -2px;
        line-height: 1;
    }
    
    #timer-label {
        font-size: 1.4rem;
        color: var(--main-color);
        font-weight: bold;
        transition: color 0.6s ease;
        margin-top: 5px;
    }

    .controls-group {
        display: flex;
        gap: 15px;
        width: 100%;
        max-width: 500px;
        justify-content: center;
    }

    .control-btn {
        flex: 1;
        background: white;
        border: 2px solid var(--main-color);
        border-radius: 35px;
        padding: 14px 0;
        font-size: 1.1rem;
        font-weight: bold;
        color: var(--btn-text);
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .control-btn:hover:not(:disabled) {
        background: var(--main-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .control-btn:disabled {
        color: #ccc;
        border-color: #eee;
        background: #fafafa;
        box-shadow: none;
    }
</style>

<div class="timer-container theme-work" id="main-container">
    <div id="achievement-msg">
        ğŸ‰ ä»Šæ—¥ã®ç›®æ¨™ã‚’é”æˆã—ã¾ã—ãŸï¼
    </div>

    <div class="goal-section">
        <div class="goal-label">ä»Šæ—¥ã®ç›®æ¨™</div>
        <div id="roulette-result">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="timer-circle-wrapper">
        <svg width="320" height="320">
            <circle class="timer-background" cx="160" cy="160" r="145"></circle>
            <circle class="timer-progress" id="progress-bar" cx="160" cy="160" r="145"></circle>
        </svg>
        <div class="timer-content">
            <div id="timer-display">00:00</div>
            <div id="timer-label">ä½œæ¥­ä¸­</div>
        </div>
    </div>

    <div class="controls-group">
        <button id="start-btn" class="control-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="pause-btn" class="control-btn" disabled>ä¸€æ™‚åœæ­¢</button>
        <button id="reset-btn" class="control-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<audio id="alarm-sound" src="{{ url_for('static', filename='sounds/alarm.mp3') }}"></audio>
{% endblock %}

{% block scripts %}
<script>
// --- æ™‚é–“è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç”¨ 5ç§’/5ç§’ï¼‰ ---
const WORK_TIME = 1500; 
const BREAK_TIME = 300;

let timerInterval;
let timeLeft = WORK_TIME;
let isRunning = false;
let currentMode = 'work';
let completedSets = 0;
let targetSets = 0;

const container = document.getElementById('main-container');
const display = document.getElementById('timer-display');
const label = document.getElementById('timer-label');
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const resetBtn = document.getElementById('reset-btn');
const alarmSound = document.getElementById('alarm-sound');
const rouletteResult = document.getElementById('roulette-result');
const progressBar = document.getElementById('progress-bar');
const achievementMsg = document.getElementById('achievement-msg');

const radius = progressBar.r.baseVal.value;
const circumference = 2 * Math.PI * radius;

progressBar.style.strokeDasharray = `${circumference} ${circumference}`;
progressBar.style.strokeDashoffset = 0;

function setProgress(percent) {
    const offset = percent <= 0 ? circumference : circumference - (percent / 100) * circumference;
    progressBar.style.strokeDashoffset = offset;
}

function updateDisplay() {
    const mins = Math.floor(timeLeft / 60);
    const secs = timeLeft % 60;
    display.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    
    const totalTime = currentMode === 'work' ? WORK_TIME : BREAK_TIME;
    const percentage = (timeLeft / totalTime) * 100;
    setProgress(percentage);

    // ç›®æ¨™å€¤ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚Œã°è¡¨ç¤ºã‚’ç¶­æŒ
    if (targetSets > 0) {
        rouletteResult.textContent = targetSets + " ã‚»ãƒƒãƒˆ";
    }
}

function loadParams() {
    fetch('/api/goal/today')
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success' && data.target_sets) {
                targetSets = data.target_sets;
                rouletteResult.textContent = targetSets + " ã‚»ãƒƒãƒˆ";
            } else {
                rouletteResult.textContent = "æœªè¨­å®š";
            }
        })
        .catch(() => {
            rouletteResult.textContent = "å–å¾—ã‚¨ãƒ©ãƒ¼";
        });
}

function startTimer() {
    if (isRunning) return;
    achievementMsg.style.display = 'none'; 
    progressBar.classList.remove('no-transition');
    alarmSound.pause();
    alarmSound.currentTime = 0;
    isRunning = true;
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    timerInterval = setInterval(() => {
        timeLeft--;
        updateDisplay();
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            setTimeout(finishSession, 1000);
        }
    }, 1000);
}

function pauseTimer() {
    isRunning = false;
    clearInterval(timerInterval);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
}

function resetTimer() {
    pauseTimer();
    alarmSound.pause();
    alarmSound.currentTime = 0;
    progressBar.classList.add('no-transition');
    timeLeft = currentMode === 'work' ? WORK_TIME : BREAK_TIME;
    updateDisplay();
}

function saveStats() {
    fetch('/api/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            duration: Math.floor(WORK_TIME / 60) || 25,
            sets: 1 
        })
    })
    .then(res => res.json())
    .then(data => console.log("å®Ÿç¸¾ä¿å­˜:", data));
}

function finishSession() {
    isRunning = false;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    alarmSound.play().catch(e => console.log(e));

    if (currentMode === 'work') {
        completedSets++;
        saveStats();
        
        // é”æˆåˆ¤å®š
        if (targetSets > 0 && completedSets >= targetSets) {
            achievementMsg.style.display = 'block';
        }

        currentMode = 'break';
        timeLeft = BREAK_TIME;
        label.textContent = 'ä¼‘æ†©ä¸­';
        container.classList.replace('theme-work', 'theme-break');
    } else {
        currentMode = 'work';
        timeLeft = WORK_TIME;
        label.textContent = 'ä½œæ¥­ä¸­';
        container.classList.replace('theme-break', 'theme-work');
    }
    progressBar.classList.add('no-transition');
    updateDisplay();
}

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
resetBtn.addEventListener('click', resetTimer);

loadParams();
updateDisplay();
</script>
{% endblock %}